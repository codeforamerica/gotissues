<!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<title>Got Issues</title>

		<!-- Chart.js graphing library and Moment.js to do date formatting and manipulation. -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment.min.js"></script>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

		<!-- Check the CfA Style Guide at https://style.codeforamerica.org/ -->
		<link rel="stylesheet" href="https://style.codeforamerica.org/style/css/main.css">
		<link rel="stylesheet" href="https://style.codeforamerica.org/style/css/layout.css" media="all and (min-width: 40em)">

		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">

		<link rel="shortcut icon" type="image/x-icon" href="https://style.codeforamerica.org/1/favicon.ico">
		<link rel="apple-touch-icon-precomposed" href="https://style.codeforamerica.org/1/style/favicons/60x60/flag-red.png"/>

	</head>

	<body>
		<header class="slab-blue">
			<div class="layout-breve">
				<h1>Civic Issue Finder Analytics</h1>
				<p>Does the <a href="http:www.codeforamerica.org/geeks/civicissues">civic issue finder</a> actually work? Lets explore the data to find out.</p>
			</div>
		</header>

		<section>
			<div class="layout-breve">
				
				<div class="badge-heading badge-graph badge-gray">
					<h2>Measuring Impact</h2>
				</div>

				<ul class="bricks bricks-cta bricks-3">
					
					<li class="brick badge-heading badge-blue">
						<a class="brick-link">
							<h4 class="brick-text">{{ data.total_clicks }}</h4>
							<h2 class="brick-heading">Total Clicks</h2>
						</a>
					</li>

					<li class="brick badge-heading badge-red">
						<a class="brick-link">
							<h4 class="brick-text">{{ data.total_page_views }}</h4>
							<h2 class="brick-heading">Total Page Views</h2>
						</a>
					</li>
		
					<li class="brick badge-heading badge-dark-blue">
							<a class="brick-link">
									<h4 class="brick-text">{{ data.clicks_per_view }}%</h4>
									<h2 class="brick-heading">Clicks Per Page View</h2>
							</a>
					</li>
				
				</ul>
			
			</div>
			<div style="padding-top:0"class="layout-breve">
				<div id="topembeds">
					


				<div id="weeklyclicks" style="margin-top:11em">
					<div class="badge-heading badge-gray">
						<h2>Breaking it Down</h2>
					</div>
					<div id="embed-api-auth-container"></div>
					<h3> Click Frequency By Month</h3>
					<div id="clickschart" ></div>
					<div id="view-selector-container" hidden></div>
					<div class="badge-heading badge-glasses badge-gray">
					<h3> Top Embed Sources: Visualized</h3>
				</div>
					<div id="chart-4-container"></div>
					<div id="legend-4-container"></div>
				</div>

				
					<h3>Top Embeds</h3>
					
			
			<div class="layout-grid-crotchet">
						{% for source in data["sources"]%}
							<div>
								<center>

									<h4 class="brick-text">{{source[1]}} Views </h4>
									<h2 style="font-size:.8em" class="brick-heading">
										<a href="{{source[0]}}">{{source[0]}}</a>
									</h2>
								</center>
							</div>
						{% endfor %}
			</div>
			</div>
			
			</div>
		</section>

		<section style="padding-bottom:3em" class="slab-teal">
			<div class="layout-breve">

				<div class="badge-heading badge-github badge-gray">
					<h1>Github Activity</h1>
				</div>

				<h2>Caused by a Click</h2>
				<p>Measuring all activity on a repo within <b>24 hours of a click</b> 
					related to that particular issue that was clicked on.
				</p>
				
				<div class="layout-grid">
					{% for activity in data["activities"] | dictsort(false, 'value') | reverse %}
						<div class="layout-crotchet hideme2"><a class="EventClick" href="#{{activity[0]}}" class="billboard">
							<h1>{{activity[1]}}</h1>
							<h2 style="margin-top:-.9em;font-size:1.4em;">{{activity[0]}}s</h2>
						</a></div>
					{% endfor %}
				</div>
			
			</div>

		<!-- featured stats -->

			<div class="layout-breve">

				<div class="badge-heading badge-graph badge-gray">
					<h2>Key Title Words by Event</h2>
					<h4>Using these words when creating titles in yields these actions</h4>
				</div>
			<div class="grid-layout">

        	{% for title_arr in data["top_titles"] %}
        	<div class="layout-crotchet">
        		<a class="billboard" id="{{title_arr}}" style="color:black"><h4 id="{{title_arr}}">{{title_arr}}</h4>{% for title in data["top_titles"][title_arr] %}
        			{{ title }}
        		{% endfor %}</a>
        	</div>
        	{% endfor %}
				</div>
			</div>
		</section>
	
	</body>

	<script>
(function(w,d,s,g,js,fs){
	g=w.gapi||(w.gapi={});g.analytics={q:[],ready:function(f){this.q.push(f);}};
	js=d.createElement(s);fs=d.getElementsByTagName(s)[0];
	js.src='https://apis.google.com/js/platform.js';
	fs.parentNode.insertBefore(js,fs);js.onload=function(){g.load('analytics');};
}(window,document,'script'));
</script>
<script>
$(document).ready(function() {
    
    $('.EventClick').click( function(){
    	console.log($(this).attr('href'));
    	var highlight = $(this).attr('href');
    	$(highlight).fadeTo( 1000, 0.65, function(){
    		$(highlight).fadeTo( "slow", 1 );
    	});
    })

    /* Every time the window is scrolled ... */
    $(window).scroll( function(){
    
        /* Check the location of each desired element */
        $('.hideme').each( function(i){
            
            var bottom_of_object = $(this).offset().top + $(this).outerHeight();
            var bottom_of_window = $(window).scrollTop() + $(window).height();
            
            /* If the object is completely visible in the window, fade it it */
            if( bottom_of_window > bottom_of_object ){
                
                $(this).animate({'opacity':'1'},500);
                    
            }
            
        });

        $('.hideme2').each( function(i){
            
            var bottom_of_object = $(this).offset().top + $(this).outerHeight();
            var bottom_of_window = $(window).scrollTop() + $(window).height();
            
            /* If the object is completely visible in the window, fade it it */
            if( bottom_of_window > bottom_of_object ){
                
                $(this).animate({'opacity':'1'},1500);
                    
            }
            
        }); 
    
    });
    
});
</script>
<script>

gapi.analytics.ready(function() {

	/**
	 * Authorize the user immediately if the user has already granted access.
	 * If no access has been created, render an authorize button inside the
	 * element with the ID "embed-api-auth-container".
	 */
	gapi.analytics.auth.authorize({
		serverAuth: {
			access_token: "{{ data['access_token'] }}"
		}
	});


	/**
	 * Create a new ViewSelector instance to be rendered inside of an
	 * element with the id "view-selector-container".
	 */
	var viewSelector = new gapi.analytics.ViewSelector({
		container: 'view-selector-container'
	});

	 //Render the view selector to the page.
	viewSelector.execute();

	/**
	 * Create a new DataChart instance with the given query parameters
	 * and Google chart options. It will be rendered inside an element
	 * with the id "chart-container".
	 */

	 var clicks = new gapi.analytics.googleCharts.DataChart({
		query: {
			metrics: 'ga:totalEvents',
			dimensions: 'ga:week',
			filters : 'ga:eventCategory==Civic Issues',
			sort : 'ga:week',
			'start-date':'2014-08-24',
			'end-date': 'today'
		},
		chart: {
			container: 'clickschart',
			type: 'COLUMN',
			options: {
				legend: null,
				width: '100%',
				title:'Number Of Times All Issues Have Been Clicked by Month'
			}
		}
	});

	/*
	 * Render the dataChart on the page whenever a new view is selected.
	 */
	viewSelector.on('change', function(ids) {
		clicks.set({query: {ids: ids}}).execute();

		renderTopSourcesChart(ids);
	});

	function renderTopSourcesChart(ids) {
    query({
      'ids': ids,
      'dimensions': 'ga:eventLabel',
      'metrics': 'ga:totalEvents',
      'sort': '-ga:totalEvents',
      'filters':'ga:eventCategory==Civic Issue View',
      'start-date':'2014-08-24',
			'end-date': 'today',
      'max-results': 50
    })
    .then(function(response) {

      var data = [];
      var colors = ['#4D5360','#949FB1','#D4CCC5','#E2EAE9','#F7464A'];

      response.rows.forEach(function(row, i) {
        row[0] = row[0].split(',')[1];
        row[0] = "http:" + row[0].split(':')[1];

        i = data.length % 5; 
        if (data.length == 0){
		    	data.push({
		        label: row[0],
		        value: +row[1],
		        color: colors[i]
		      });
		    } else {
		    		for(var j=0; j<data.length; j++){
		    			if(data[j]['label'] == row[0]){
		    				j = data.length;
		    			}
		    			if(j == data.length - 1){
		    				data.push({
					        label: row[0],
					        value: +row[1],
					        color: colors[i]
					      });
		    			}
		    		}
		    	}
      });

      new Chart(makeCanvas('chart-4-container')).Doughnut(data);
      //generateLegend('legend-4-container', data);
    });
  }


  /**
   * Extend the Embed APIs `gapi.analytics.report.Data` component to
   * return a promise the is fulfilled with the value returned by the API.
   * @param {Object} params The request parameters.
   * @return {Promise} A promise.
   */
  function query(params) {
    return new Promise(function(resolve, reject) {
      var data = new gapi.analytics.report.Data({query: params});
      data.once('success', function(response) { resolve(response); })
          .once('error', function(response) { reject(response); })
          .execute();
    });
  }


  /**
   * Create a new canvas inside the specified element. Set it to be the width
   * and height of its container.
   * @param {string} id The id attribute of the element to host the canvas.
   * @return {RenderingContext} The 2D canvas context.
   */
  function makeCanvas(id) {
    var container = document.getElementById(id);
    var canvas = document.createElement('canvas');
    var ctx = canvas.getContext('2d');

    container.innerHTML = '';
    canvas.width = container.offsetWidth;
    canvas.height = container.offsetHeight;
    container.appendChild(canvas);

    return ctx;
  }

  // Set some global Chart.js defaults.
  Chart.defaults.global.animationSteps = 60;
  Chart.defaults.global.animationEasing = 'easeInOutQuart';
  Chart.defaults.global.responsive = true;
  Chart.defaults.global.maintainAspectRatio = false;



});
</script>

</html>